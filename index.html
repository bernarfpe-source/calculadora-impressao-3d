import { useState, useMemo, useEffect, useCallback } from "react";

const materialData = {
  PLA: { pricePerKg: 120, density: 1.24, description: "Mais comum, f√°cil de imprimir" },
  ABS: { pricePerKg: 140, density: 1.04, description: "Resistente, uso industrial" },
  PETG: { pricePerKg: 150, density: 1.27, description: "Resistente e flex√≠vel" },
  TPU: { pricePerKg: 200, density: 1.21, description: "Flex√≠vel, borrachudo" },
  Nylon: { pricePerKg: 280, density: 1.14, description: "Alta resist√™ncia mec√¢nica" },
  Resina: { pricePerKg: 250, density: 1.10, description: "Alta defini√ß√£o (SLA/DLP)" },
  ASA: { pricePerKg: 180, density: 1.07, description: "Resistente a UV, uso externo" },
  PC: { pricePerKg: 300, density: 1.20, description: "Policarbonato, alta resist√™ncia" },
};
const marketplacePresets = {
  nenhum: { label: "Venda direta", taxa: 0, desc: "Sem marketplace" },
  mercadolivre: { label: "Mercado Livre", taxa: 13, desc: "~11-16% s/ categoria" },
  shopee: { label: "Shopee", taxa: 14, desc: "~12-18% + comiss√£o" },
  amazon: { label: "Amazon", taxa: 15, desc: "~8-20% s/ categoria" },
  custom: { label: "Personalizado", taxa: 0, desc: "Defina sua taxa" },
};
const statusOptions = [
  { id: "verificada", label: "Verificada", color: "#00d4aa", icon: "‚úÖ" },
  { id: "pendente", label: "Pendente", color: "#ffd43b", icon: "‚è≥" },
  { id: "problema", label: "Problema", color: "#ff6b6b", icon: "‚ö†Ô∏è" },
  { id: "favorita", label: "Favorita", color: "#e599f7", icon: "‚≠ê" },
];

function NI({ label, value, onChange, unit, step = 1, min = 0, helpText, T: t }) {
  const d = t || { bg3: "#1e1e2e", border2: "#3a3a4a", text: "#f0f0f0", text2: "#c0c0c0", text4: "#888", text5: "#666", accent: "#7c5cfc" };
  return (<div style={{ marginBottom: 16 }}>
    <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: d.text2, marginBottom: 6, letterSpacing: "0.5px", textTransform: "uppercase" }}>{label}</label>
    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
      <input type="number" value={value} onChange={(e) => onChange(parseFloat(e.target.value) || 0)} step={step} min={min}
        style={{ flex: 1, padding: "10px 14px", borderRadius: 10, border: `1px solid ${d.border2}`, background: d.bg3, color: d.text, fontSize: 16, outline: "none" }}
        onFocus={(e) => (e.target.style.borderColor = d.accent)} onBlur={(e) => (e.target.style.borderColor = d.border2)} />
      {unit && <span style={{ color: d.text4, fontSize: 14, minWidth: 30 }}>{unit}</span>}
    </div>
    {helpText && <span style={{ fontSize: 11, color: d.text5, marginTop: 4, display: "block" }}>{helpText}</span>}
  </div>);
}
function SI({ label, value, onChange, min, max, step = 1, unit = "%", helpText, T: t }) {
  const d = t || { text2: "#c0c0c0", text5: "#666", accent: "#7c5cfc" };
  return (<div style={{ marginBottom: 16 }}>
    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
      <label style={{ fontSize: 13, fontWeight: 600, color: d.text2, letterSpacing: "0.5px", textTransform: "uppercase" }}>{label}</label>
      <span style={{ fontSize: 15, fontWeight: 700, color: d.accent }}>{value}{unit}</span>
    </div>
    <input type="range" min={min} max={max} step={step} value={value} onChange={(e) => onChange(parseFloat(e.target.value))} style={{ width: "100%", accentColor: d.accent }} />
    {helpText && <span style={{ fontSize: 11, color: d.text5, marginTop: 2, display: "block" }}>{helpText}</span>}
  </div>);
}
function CC({ label, value, icon, color = "#7c5cfc", sub, T: t }) {
  const d = t || { cardGrad: "linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%)", text4: "#888", text5: "#666" };
  return (<div style={{ background: d.cardGrad, borderRadius: 14, padding: "14px 16px", border: `1px solid ${color}22`, flex: 1, minWidth: 120 }}>
    <div style={{ fontSize: 20, marginBottom: 4 }}>{icon}</div>
    <div style={{ fontSize: 10, color: d.text4, textTransform: "uppercase", letterSpacing: "0.5px", marginBottom: 3 }}>{label}</div>
    <div style={{ fontSize: 18, fontWeight: 800, color }}>{value}</div>
    {sub && <div style={{ fontSize: 10, color: d.text5, marginTop: 3 }}>{sub}</div>}
  </div>);
}

const LOGO = "data:image/png;base64,..."; // Mantendo seu logo original
const SK = "print3d-archive";
async function ldA() { try { const r = await window.storage.get(SK); return r ? JSON.parse(r.value) : []; } catch { return []; } }
async function svA(items) { try { await window.storage.set(SK, JSON.stringify(items)); } catch (e) { console.error(e); } }

export default function App() {
  const [pg, sPg] = useState(50), [th, sTh] = useState(4), [tm, sTm] = useState(30), [mat, sMat] = useState("PLA");
  const [ci, sCi] = useState(3000), [vu, sVu] = useState(5000), [pw, sPw] = useState(250), [ckw, sCkw] = useState(0.85);
  const [inf, sInf] = useState(20), [fp, sFp] = useState(5);
  const [lix, sLix] = useState(false), [pin, sPin] = useState(false), [acab, sAcab] = useState(false), [sup, sSup] = useState(true);
  const [vhm, sVhm] = useState(30), [tsu, sTsu] = useState(15), [tpp, sTpp] = useState(20);
  const [ml, sMl] = useState(50), [qtd, sQtd] = useState(1), [cfm, sCfm] = useState(200), [hm, sHm] = useState(200);
  const [ff, sFf] = useState(15), [fpc, sFpc] = useState(true), [ce, sCe] = useState(3);
  const [rt, sRt] = useState("mei"), [ac, sAc] = useState(6);
  const [mk, sMk] = useState("nenhum"), [tmc, sTmc] = useState(15), [tfm, sTfm] = useState(0);
  const [tab, sTab] = useState("peca");
  const [arch, sArch] = useState([]), [aLoad, sALoad] = useState(true);
  const [nome, sNome] = useState(""), [notas, sNotas] = useState(""), [status, sStatus] = useState("verificada");
  const [search, sSearch] = useState(""), [filt, sFilt] = useState("todos"), [sort, sSort] = useState("data");
  const [cdel, sCdel] = useState(null), [saved, sSaved] = useState(false);
  const [img, sImg] = useState(null); // Estado para a imagem
  const [dark, setDark] = useState(() => { try { return localStorage.getItem("print3d-theme") !== "light"; } catch { return true; } });

  useEffect(() => { try { localStorage.setItem("print3d-theme", dark ? "dark" : "light"); } catch { } }, [dark]);
  useEffect(() => { ldA().then(i => { sArch(i); sALoad(false); }); }, []);

  // Handler para Ctrl+V
  useEffect(() => {
    const handlePaste = (e) => {
      const items = e.clipboardData.items;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") !== -1) {
          const blob = items[i].getAsFile();
          const reader = new FileReader();
          reader.onload = (event) => sImg(event.target.result);
          reader.readAsDataURL(blob);
        }
      }
    };
    window.addEventListener("paste", handlePaste);
    return () => window.removeEventListener("paste", handlePaste);
  }, []);

  const T = useMemo(() => dark ? {
    bg: "#12121e", bg2: "#1a1a2e", bg3: "#1e1e2e", bg4: "#12121e",
    border: "#2a2a3e", border2: "#3a3a4a",
    text: "#f0f0f0", text2: "#c0c0c0", text3: "#aaa", text4: "#888", text5: "#666", text6: "#555", text7: "#444",
    accent: "#7c5cfc", accentBg: "#7c5cfc18",
    cardGrad: "linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%)",
    pricingBg: "linear-gradient(135deg, #7c5cfc15, #00d4aa15)",
  } : {
    bg: "#f5f5f8", bg2: "#ffffff", bg3: "#f0f0f5", bg4: "#f8f8fb",
    border: "#e0e0e8", border2: "#d0d0d8",
    text: "#1a1a2e", text2: "#333", text3: "#555", text4: "#777", text5: "#999", text6: "#aaa", text7: "#ccc",
    accent: "#6a4ce0", accentBg: "#6a4ce018",
    cardGrad: "linear-gradient(135deg, #ffffff 0%, #f0f0f5 100%)",
    pricingBg: "linear-gradient(135deg, #6a4ce012, #00b89012)",
  }, [dark]);

  const aImp = useMemo(() => ({ mei: 5, simples: 6, presumido: 11.33, real: 15, informal: 0, custom: ac })[rt] ?? 5, [rt, ac]);
  const tMk = useMemo(() => mk === "nenhum" ? 0 : mk === "custom" ? tmc : marketplacePresets[mk].taxa, [mk, tmc]);

  const c = useMemo(() => {
    const m = materialData[mat], tH = th + tm / 60;
    const cMat = (pg / 1000) * m.pricePerKg, cEn = (pw / 1000) * tH * ckw, dep = (ci / vu) * tH;
    const cMdo = ((tsu + tpp) / 60) * vhm;
    let cPos = 0; if (lix) cPos += 2.5; if (pin) cPos += 8; if (acab) cPos += 5; if (sup) cPos += 1.5;
    const cFalha = (cMat + cEn) * (fp / 100), rCF = (cfm / hm) * tH, cEmb = ce, cFr = fpc ? 0 : ff;
    const cProd = cMat + cEn + dep + cMdo + cPos + cFalha + rCF + cEmb + cFr;
    const pBase = cProd * (1 + ml / 100), tTx = (tMk / 100) + (aImp / 100);
    const pFin = tTx < 1 ? pBase / (1 - tTx) : pBase * 2;
    const vImp = pFin * (aImp / 100), vMk = pFin * (tMk / 100) + tfm;
    const cTot = cProd + vImp + vMk, lucro = pFin - cTot;
    return {
      cMat, cEn, dep, cMdo, cPos, cFalha, rCF, cEmb, cFr, cProd, vImp, vMk, cTot, pVenda: pFin, lucro,
      cTotLote: cTot * qtd, pVendaLote: pFin * qtd, lucroLote: lucro * qtd, tH, pesoTot: pg * qtd,
      mReal: cTot > 0 ? (lucro / cTot * 100) : 0
    };
  }, [pg, th, tm, mat, ci, vu, pw, ckw, inf, fp, lix, pin, acab, sup, vhm, tsu, tpp, ml, qtd, cfm, hm, ff, fpc, ce, aImp, tMk, tfm]);

  const doSave = useCallback(async () => {
    if (!nome.trim()) return;
    const np = {
      id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6), nome: nome.trim(), notas: notas.trim(), status, data: new Date().toISOString(), img,
      params: { pg, th, tm, mat, inf, qtd, lix, pin, acab, sup, mk, rt, ml, fpc, ff, ce },
      res: { cProd: c.cProd, cTot: c.cTot, pVenda: c.pVenda, lucro: c.lucro, mReal: c.mReal }
    };
    const u = [np, ...arch]; sArch(u); await svA(u); sNome(""); sNotas(""); sImg(null); sSaved(true); setTimeout(() => sSaved(false), 2000);
  }, [nome, notas, status, pg, th, tm, mat, inf, qtd, lix, pin, acab, sup, mk, rt, ml, fpc, ff, ce, c, arch, img]);

  const doDelete = useCallback(async (id) => { const u = arch.filter(p => p.id !== id); sArch(u); await svA(u); sCdel(null); }, [arch]);
  const doLoad = useCallback((p) => {
    const d = p.params; sPg(d.pg); sTh(d.th); sTm(d.tm); sMat(d.mat); sInf(d.inf); sQtd(d.qtd);
    sLix(d.lix); sPin(d.pin); sAcab(d.acab); sSup(d.sup); sMk(d.mk); sRt(d.rt); sMl(d.ml); sFpc(d.fpc); sFf(d.ff); sCe(d.ce); sImg(p.img || null); sTab("peca");
  }, []);
  const doStatus = useCallback(async (id, ns) => { const u = arch.map(p => p.id === id ? { ...p, status: ns } : p); sArch(u); await svA(u); }, [arch]);
  const doClear = useCallback(async () => { sArch([]); await svA([]); sCdel(null); }, []);

  const fArch = useMemo(() => {
    let it = arch;
    if (filt !== "todos") it = it.filter(p => p.status === filt);
    if (search.trim()) { const q = search.toLowerCase(); it = it.filter(p => p.nome.toLowerCase().includes(q) || (p.notas || "").toLowerCase().includes(q) || p.params.mat.toLowerCase().includes(q)); }
    if (sort === "data") it = [...it].sort((a, b) => new Date(b.data) - new Date(a.data));
    else if (sort === "nome") it = [...it].sort((a, b) => a.nome.localeCompare(b.nome));
    else if (sort === "preco") it = [...it].sort((a, b) => b.res.pVenda - a.res.pVenda);
    else if (sort === "lucro") it = [...it].sort((a, b) => b.res.lucro - a.res.lucro);
    return it;
  }, [arch, filt, search, sort]);

  const aStats = useMemo(() => !arch.length ? null : ({
    total: arch.length, verif: arch.filter(p => p.status === "verificada").length,
    receita: arch.reduce((s, p) => s + p.res.pVenda * (p.params.qtd || 1), 0),
    lucro: arch.reduce((s, p) => s + p.res.lucro * (p.params.qtd || 1), 0),
  }), [arch]);

  const f = v => `R$ ${v.toFixed(2)}`;
  const tabs = [
    { id: "peca", label: "üéØ Pe√ßa" }, { id: "custos", label: "‚ö° Opera√ß√£o" }, { id: "mdo", label: "üë∑ M√£o de Obra" },
    { id: "acabamento", label: "‚ú® Acabamento" }, { id: "venda", label: "üì¶ Venda" }, { id: "negocio", label: "üíº Neg√≥cio" },
    { id: "arquivo", label: `üóÇÔ∏è Arquivo (${arch.length})` },
  ];

  const bdi = [
    { l: "Material", v: c.cMat, cl: "#7c5cfc" }, { l: "Energia", v: c.cEn, cl: "#00d4aa" }, { l: "Deprecia√ß√£o", v: c.dep, cl: "#ff6b6b" },
    { l: "M√£o de obra", v: c.cMdo, cl: "#ffa94d" }, { l: "P√≥s-proc.", v: c.cPos, cl: "#74c0fc" }, { l: "Falhas", v: c.cFalha, cl: "#e599f7" },
    { l: "Custos fixos", v: c.rCF, cl: "#69db7c" }, { l: "Embalagem", v: c.cEmb, cl: "#d0bfff" }, { l: "Frete", v: c.cFr, cl: "#a9e34b" },
    { l: "Impostos", v: c.vImp, cl: "#ff8787" }, { l: "Marketplace", v: c.vMk, cl: "#ffd43b" },
  ].filter(i => i.v > 0);

  const isA = tab === "arquivo";

  const Btn = ({ children, active, color = "#7c5cfc", onClick, style: sx = {} }) => (
    <button onClick={onClick} style={{ padding: "8px 14px", borderRadius: 8, cursor: "pointer", fontSize: 12, fontWeight: 600, border: active ? `2px solid ${color}` : `1px solid ${T.border2}`, background: active ? `${color}18` : T.bg3, color: active ? color : T.text4, transition: "all 0.15s", ...sx }}>{children}</button>
  );

  return (
    <div style={{ minHeight: "100vh", background: T.bg, color: T.text, fontFamily: "'Inter',-apple-system,sans-serif", transition: "background 0.3s, color 0.3s" }}>
      <div style={{ maxWidth: 920, margin: "0 auto", padding: "24px 16px" }}>
        <div style={{ textAlign: "center", marginBottom: 28, position: "relative" }}>
          <button onClick={() => setDark(!dark)} style={{ position: "absolute", right: 0, top: 0, padding: "10px 14px", borderRadius: 12, border: `1px solid ${T.border}`, background: T.bg2, cursor: "pointer", fontSize: 20, lineHeight: 1 }} title={dark ? "Modo claro" : "Modo escuro"}>{dark ? "‚òÄÔ∏è" : "üåô"}</button>
          <img src={LOGO} alt="CB2K" style={{ width: 80, height: 80, marginBottom: 8, borderRadius: 12 }} />
          <h1 style={{ fontSize: 26, fontWeight: 800, margin: 0, background: "linear-gradient(135deg,#7c5cfc,#00d4aa)", WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent" }}>CB¬≤K Presentes 3D</h1>
          <p style={{ color: T.text5, fontSize: 14, marginTop: 6 }}>Calculadora de custos para impress√£o 3D</p>
        </div>

        {!isA && <div style={{ display: "flex", gap: 10, flexWrap: "wrap", marginBottom: 24 }}>
          <CC icon="üè≠" label="Custo Produ√ß√£o" value={f(c.cProd)} color="#ff6b6b" sub="Sem impostos/taxas" T={T} />
          <CC icon="üí∞" label="Custo Total" value={f(c.cTot)} color="#ffa94d" sub={`${qtd}x = ${f(c.cTotLote)}`} T={T} />
          <CC icon="üè∑Ô∏è" label="Pre√ßo Venda" value={f(c.pVenda)} color="#00d4aa" sub={`Margem: ${c.mReal.toFixed(1)}%`} T={T} />
          <CC icon="üìà" label="Lucro L√≠quido" value={f(c.lucro)} color="#7c5cfc" sub={`Total: ${f(c.lucroLote)}`} T={T} />
        </div>}

        <div style={{ display: "flex", gap: 4, marginBottom: 20, overflowX: "auto", paddingBottom: 4 }}>
          {tabs.map(t => <button key={t.id} onClick={() => sTab(t.id)} style={{
            padding: "10px 16px", borderRadius: 10, border: "none", fontSize: 13, fontWeight: 600, cursor: "pointer", whiteSpace: "nowrap",
            background: tab === t.id ? (t.id === "arquivo" ? "linear-gradient(135deg,#00d4aa,#0a9d80)" : "linear-gradient(135deg,#7c5cfc,#5a3fd4)") : T.bg3,
            color: tab === t.id ? "#fff" : T.text4,
          }}>{t.label}</button>)}
        </div>

        {tab === "peca" && (
          <div style={{ display: "flex", gap: 20, flexWrap: "wrap" }}>
            <div style={{ flex: 1, minWidth: 300 }}>
              <div style={{ background: T.bg2, borderRadius: 16, padding: 24, border: `1px solid ${T.border}` }}>
                <h3 style={{ margin: "0 0 18px", fontSize: 16 }}>üìê Dados da Pe√ßa</h3>

                {/* AREA DE IMAGEM HORIZONTAL */}
                <div style={{ display: "flex", alignItems: "center", gap: 15, background: T.bg3, padding: 12, borderRadius: 12, border: `1px dashed ${T.border2}`, marginBottom: 20 }}>
                  <div style={{ width: 80, height: 80, borderRadius: 8, background: T.bg4, display: "flex", alignItems: "center", justifyContent: "center", border: `1px solid ${T.border}`, overflow: "hidden" }}>
                    {img ? <img src={img} style={{ width: "100%", height: "100%", objectFit: "cover" }} /> : <span style={{ fontSize: 24 }}>üñºÔ∏è</span>}
                  </div>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 13, fontWeight: 700, color: T.text2, marginBottom: 4 }}>Foto da Pe√ßa</div>
                    <div style={{ fontSize: 11, color: T.text5, marginBottom: 8 }}>Clique para enviar ou use <b>Ctrl+V</b></div>
                    <div style={{ display: "flex", gap: 8 }}>
                      <label style={{ padding: "6px 12px", background: T.accent, color: "#fff", borderRadius: 6, fontSize: 12, fontWeight: 600, cursor: "pointer" }}>
                        Escolher...
                        <input type="file" accept="image/*" style={{ display: "none" }} onChange={e => {
                          const file = e.target.files[0];
                          if (file) {
                            const reader = new FileReader();
                            reader.onload = (ev) => sImg(ev.target.result);
                            reader.readAsDataURL(file);
                          }
                        }} />
                      </label>
                      {img && <button onClick={() => sImg(null)} style={{ padding: "6px 12px", background: "#ff6b6b22", color: "#ff6b6b", border: "1px solid #ff6b6b44", borderRadius: 6, fontSize: 12, fontWeight: 600, cursor: "pointer" }}>Remover</button>}
                    </div>
                  </div>
                </div>

                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: "#c0c0c0", marginBottom: 6, textTransform: "uppercase" }}>Material</label>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                    {Object.entries(materialData).map(([k, m]) => (
                      <button key={k} onClick={() => sMat(k)} style={{
                        padding: "10px 12px", borderRadius: 10, textAlign: "left", cursor: "pointer",
                        border: mat === k ? "2px solid #7c5cfc" : `1px solid ${T.border2}`, background: mat === k ? "#7c5cfc18" : T.bg3, color: mat === k ? "#7c5cfc" : T.text3, fontSize: 13, fontWeight: 600
                      }}>
                        <div>{k}</div><div style={{ fontSize: 10, color: T.text5, marginTop: 2 }}>{m.description}</div><div style={{ fontSize: 10, color: "#7c5cfc", marginTop: 2 }}>R$ {m.pricePerKg}/kg</div>
                      </button>
                    ))}
                  </div>
                </div>
                <NI T={T} label="Peso da pe√ßa" value={pg} onChange={sPg} unit="g" helpText="Peso estimado pelo slicer" />
                <div style={{ display: "flex", gap: 12 }}><div style={{ flex: 1 }}><NI T={T} label="Horas" value={th} onChange={sTh} unit="h" /></div><div style={{ flex: 1 }}><NI T={T} label="Min" value={tm} onChange={sTm} unit="min" /></div></div>
                <SI T={T} label="Infill" value={inf} onChange={sInf} min={5} max={100} step={5} helpText="Preenchimento" />
                <NI T={T} label="Quantidade" value={qtd} onChange={sQtd} unit="un" min={1} />
              </div>
            </div>

            {/* Mantendo o breakdown lateral */}
            <div style={{ flex: 1, minWidth: 300 }}>
              <div style={{ background: T.bg2, borderRadius: 16, padding: 24, border: `1px solid ${T.border}` }}>
                <h3 style={{ margin: "0 0 18px", fontSize: 16 }}>üìä Resumo Financeiro</h3>
                <div style={{ padding: 16, background: T.pricingBg, borderRadius: 12, border: "1px solid #7c5cfc33", marginBottom: 20 }}>
                  <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}><span style={{ color: T.text3, fontSize: 13 }}>Pre√ßo venda</span><span style={{ color: "#00d4aa", fontSize: 18, fontWeight: 800 }}>{f(c.pVenda)}</span></div>
                  <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}><span style={{ color: T.text3, fontSize: 13 }}>Lucro l√≠quido</span><span style={{ color: "#7c5cfc", fontSize: 16, fontWeight: 700 }}>{f(c.lucro)}</span></div>
                  <div style={{ display: "flex", justifyContent: "space-between" }}><span style={{ color: T.text3, fontSize: 13 }}>Margem real</span><span style={{ color: "#ffa94d", fontSize: 14, fontWeight: 700 }}>{c.mReal.toFixed(1)}%</span></div>
                </div>
                {/* Lista de decomposi√ß√£o simplificada aqui... */}
                {bdi.map(i => (
                  <div key={i.l} style={{ display: "flex", justifyContent: "space-between", padding: "8px 0", borderBottom: `1px solid ${T.border}` }}>
                    <span style={{ fontSize: 13, color: T.text4 }}>{i.l}</span>
                    <span style={{ fontSize: 13, fontWeight: 600 }}>{f(i.v)}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Outras Abas (Custos, MDO, etc) */}
        {tab === "custos" && (
          <div style={{ background: T.bg2, borderRadius: 16, padding: 24, border: `1px solid ${T.border}` }}>
            <h3 style={{ margin: "0 0 18px", fontSize: 16 }}>‚ö° Custos Operacionais</h3>
            <NI T={T} label="Custo da impressora" value={ci} onChange={sCi} unit="R$" step={100} />
            <NI T={T} label="Vida √∫til" value={vu} onChange={sVu} unit="h" step={100} />
            <NI T={T} label="Pot√™ncia" value={pw} onChange={sPw} unit="W" step={10} />
            <NI T={T} label="Custo kWh" value={ckw} onChange={sCkw} unit="R$/kWh" step={0.01} />
            <SI T={T} label="Taxa de falha" value={fp} onChange={sFp} min={0} max={30} />
          </div>
        )}

        {tab === "mdo" && (
          <div style={{ background: T.bg2, borderRadius: 16, padding: 24, border: `1px solid ${T.border}` }}>
            <h3 style={{ margin: "0 0 18px", fontSize: 16 }}>üë∑ M√£o de Obra</h3>
            <NI T={T} label="Valor hora" value={vhm} onChange={sVhm} unit="R$/h" step={5} />
            <NI T={T} label="Setup" value={tsu} onChange={sTsu} unit="min" step={5} />
            <NI T={T} label="P√≥s-processamento" value={tpp} onChange={sTpp} unit="min" step={5} />
          </div>
        )}

        {tab === "acabamento" && (
          <div style={{ background: T.bg2, borderRadius: 16, padding: 24, border: `1px solid ${T.border}` }}>
            <h3 style={{ margin: "0 0 18px", fontSize: 16 }}>‚ú® P√≥s-Processamento</h3>
            {[["Remo√ß√£o suporte", sup, sSup], ["Lixamento", lix, sLix], ["Pintura", pin, sPin], ["Acabamento especial", acab, sAcab]].map(([lb, st, set]) => (
              <button key={lb} onClick={() => set(!st)} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", width: "100%", padding: "14px 16px", marginBottom: 8, borderRadius: 10, cursor: "pointer", border: st ? "2px solid #7c5cfc" : `1px solid ${T.border2}`, background: st ? "#7c5cfc12" : T.bg3, color: T.text }}>
                <span style={{ fontSize: 14, fontWeight: 600 }}>{lb}</span>
                <span>{st ? "‚úÖ" : "‚ùå"}</span>
              </button>
            ))}
          </div>
        )}

        {tab === "venda" && (
          <div style={{ background: T.bg2, borderRadius: 16, padding: 24, border: `1px solid ${T.border}` }}>
            <h3 style={{ margin: "0 0 18px", fontSize: 16 }}>üì¶ Venda e Taxas</h3>
            <NI T={T} label="Embalagem" value={ce} onChange={sCe} unit="R$" />
            <NI T={T} label="Frete" value={ff} onChange={sFf} unit="R$" />
            <div style={{ marginBottom: 20 }}>
              <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: "#c0c0c0", marginBottom: 12 }}>Marketplace</label>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                {Object.entries(marketplacePresets).map(([k, mp]) => (
                  <button key={k} onClick={() => sMk(k)} style={{ padding: "10px 12px", borderRadius: 10, cursor: "pointer", border: mk === k ? "2px solid #ffd43b" : `1px solid ${T.border2}`, background: mk === k ? "#ffd43b15" : T.bg3, color: T.text3 }}>{mp.label}</button>
                ))}
              </div>
            </div>
          </div>
        )}

        {tab === "negocio" && (
          <div style={{ background: T.bg2, borderRadius: 16, padding: 24, border: `1px solid ${T.border}` }}>
            <h3 style={{ margin: "0 0 18px", fontSize: 16 }}>üíº Neg√≥cio</h3>
            <SI T={T} label="Margem de lucro" value={ml} onChange={sMl} min={0} max={200} step={5} />
            <NI T={T} label="Custos fixos/m√™s" value={cfm} onChange={sCfm} unit="R$" />
            <NI T={T} label="Horas produtivas/m√™s" value={hm} onChange={sHm} unit="h" />
          </div>
        )}

        {/* REUTILIZANDO A LOGICA DE ARQUIVO QUE VOCE ENVIOU */}
        {isA && (
          <div style={{ display: "flex", gap: 20, flexWrap: "wrap" }}>
            <div style={{ flex: 1, minWidth: 300 }}>
              <div style={{ background: T.bg2, borderRadius: 16, padding: 24, border: `1px solid ${T.border}`, marginBottom: 20 }}>
                <h3 style={{ margin: "0 0 18px", fontSize: 16, color: "#00d4aa" }}>üíæ Salvar Pe√ßa Atual</h3>
                <NI T={T} label="Nome da pe√ßa" value={nome} onChange={sNome} unit="" />
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: "#c0c0c0", marginBottom: 8 }}>Status</label>
                  <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                    {statusOptions.map(s => <Btn key={s.id} active={status === s.id} color={s.color} onClick={() => sStatus(s.id)}>{s.icon} {s.label}</Btn>)}
                  </div>
                </div>
                <button onClick={doSave} style={{ width: "100%", padding: 14, borderRadius: 12, background: "#00d4aa", color: "#fff", border: "none", fontWeight: 700, cursor: "pointer" }}>{saved ? "‚úÖ Salvo!" : "Salvar no Arquivo"}</button>
              </div>
            </div>

            <div style={{ flex: 1, minWidth: 300 }}>
              <div style={{ background: T.bg2, borderRadius: 16, padding: 24, border: `1px solid ${T.border}` }}>
                <h3 style={{ margin: "0 0 16px", fontSize: 16 }}>üóÇÔ∏è Itens Salvos</h3>
                <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
                  {fArch.map(p => (
                    <div key={p.id} style={{ padding: 12, background: T.bg3, borderRadius: 10, border: `1px solid ${T.border}` }}>
                      <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
                        {p.img && <img src={p.img} style={{ width: 40, height: 40, borderRadius: 4, objectFit: "cover" }} />}
                        <div style={{ flex: 1 }}>
                          <div style={{ fontSize: 14, fontWeight: 700 }}>{p.nome}</div>
                          <div style={{ fontSize: 11, color: T.text5 }}>{p.params.mat} ‚Ä¢ {f(p.res.pVenda)}</div>
                        </div>
                        <button onClick={() => doLoad(p)} style={{ padding: "4px 8px", borderRadius: 4, background: T.accent, color: "#fff", border: "none", fontSize: 10, cursor: "pointer" }}>Abrir</button>
                        <button onClick={() => doDelete(p.id)} style={{ padding: "4px 8px", borderRadius: 4, background: "#ff6b6b", color: "#fff", border: "none", fontSize: 10, cursor: "pointer" }}>X</button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        <div style={{ textAlign: "center", marginTop: 24, padding: 16, color: T.text7, fontSize: 12 }}>CB¬≤K Presentes 3D - Precifica√ß√£o Profissional</div>
      </div>
    </div>
  );
}
  
